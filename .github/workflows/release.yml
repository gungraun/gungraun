# spell-checker: ignore androideabi taiki binutils riscv
name: Release

on:
  push:
    tags: ["v[0-9]+.[0-9]+.[0-9]+"]
  workflow_dispatch:
    inputs:
      tag:
        description: "The ref/tag to use for the release"
        required: true
        type: string

permissions:
  contents: write

concurrency:
  group: ${{ github.ref }}
  cancel-in-progress: true

jobs:
  release:
    name: Create a draft release
    runs-on: ubuntu-latest
    steps:
      - name: Checkout specific tag
        if: inputs.tag
        uses: actions/checkout@v5
        with:
          ref: ${{ inputs.tag }}
      - name: Checkout default ref
        if: ${{ ! inputs.tag }}
        uses: actions/checkout@v5
      - name: Get the release version from the tag
        if: inputs.tag
        run: echo "VERSION=${{ inputs.tag }}" >> $GITHUB_ENV
      - name: Get the release version from the tag
        if: ${{ ! inputs.tag }}
        run: echo "VERSION=${{ github.ref_name }}" >> $GITHUB_ENV
      - name: Create release if it does not exist
        run: |
          if ! gh release view $VERSION &>/dev/null; then
            gh release create $VERSION --draft --verify-tag --title $VERSION -F CHANGELOG.md
          fi
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    outputs:
      version: ${{ env.VERSION }}

  build:
    name: Build release artifacts
    needs: ["release"]
    strategy:
      fail-fast: false
      matrix:
        target:
          - x86_64-unknown-linux-gnu
          - x86_64-unknown-linux-musl
          - i686-unknown-linux-gnu
          - armv7-unknown-linux-gnueabihf
          - aarch64-unknown-linux-gnu
          - powerpc-unknown-linux-gnu
          - powerpc64-unknown-linux-gnu
          - powerpc64le-unknown-linux-gnu
          - s390x-unknown-linux-gnu
          - riscv64gc-unknown-linux-gnu
          - aarch64-linux-android
          - i686-linux-android
          - armv7-linux-androideabi
          - x86_64-linux-android
          - x86_64-unknown-freebsd
          - i686-unknown-freebsd
        include:
          - toolchain: stable
          - cargo: cross
          - needs_ndk: false
          - target: armv7-linux-androideabi
            cargo: cargo
            needs_ndk: true
          - target: aarch64-linux-android
            cargo: cargo
            needs_ndk: true
          - target: i686-linux-android
            cargo: cargo
            needs_ndk: true
          - target: x86_64-linux-android
            cargo: cargo
            needs_ndk: true

    runs-on: ubuntu-latest
    steps:
      - name: Checkout specific tag
        if: inputs.tag
        uses: actions/checkout@v5
        with:
          ref: ${{ inputs.tag }}
      - name: Checkout default ref
        if: ${{ ! inputs.tag }}
        uses: actions/checkout@v5
      - uses: taiki-e/install-action@cross
      - uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: ${{ matrix.toolchain }}
          target: ${{ matrix.target }}
      - name: Prepare
        run: |
          archive_dir="gungraun-runner-${{ needs.release.outputs.version }}-${{ matrix.target }}"
          archive_name="${archive_dir}.tar.gz"
          archive_sum="${archive_name}.sha256"

          echo "ARCHIVE_DIR=${archive_dir}" >> $GITHUB_ENV
          echo "ARCHIVE_NAME=${archive_name}" >> $GITHUB_ENV
          echo "ARCHIVE_SUM=${archive_sum}" >> $GITHUB_ENV
      - name: Check
        run: |
          set -o pipefail

          if gh release view ${{ needs.release.outputs.version }} --json assets | jq -e --arg name "${{ env.ARCHIVE_NAME }}" '.assets[] | select(.name == $name)'; then
            echo "Check: archive '${{ env.ARCHIVE_NAME }}' already exists for this version '${{ needs.release.outputs.version }}'"
            echo "CHECK=failure" >> $GITHUB_ENV
          else
            echo "CHECK=success" >> $GITHUB_ENV
          fi
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      - name: Cleanup Cross.toml
        if: env.CHECK == 'success'
        run: |
          [[ -e Cross.toml ]] && mv Cross.toml Cross.toml.old || true
      # https://developer.android.com/ndk/guides/other_build_systems
      - name: Use NDK and install cargo config
        if: env.CHECK == 'success' && matrix.needs_ndk
        run: |
          set -x

          min_sdk="21"
          if [[ "${{ matrix.target }}" == "armv7-linux-androideabi" ]]; then
            binutils_prefix="arm-linux-androideabi"
            compiler_prefix="armv7a-linux-androideabi"
          else
            binutils_prefix="${{ matrix.target }}"
            compiler_prefix="${{ matrix.target }}"
          fi

          linker="${ANDROID_NDK_HOME}/toolchains/llvm/prebuilt/linux-x86_64/bin/${compiler_prefix}${min_sdk}-clang"

          cat <<EOF >~/.cargo/config
          [target.${{ matrix.target }}]
          linker = "$linker"
          EOF
      - name: Update dependencies
        if: env.CHECK == 'success'
        run: cargo update
      - name: Build gungraun-runner
        if: env.CHECK == 'success'
        run: ${{ matrix.cargo }} build -p gungraun-runner --release --target ${{ matrix.target }}
      - name: Create archive
        if: env.CHECK == 'success'
        run: |
          archive_dir="${{ env.ARCHIVE_DIR }}"
          archive_name="${{ env.ARCHIVE_NAME }}"
          archive_sum="${{ env.ARCHIVE_SUM }}"

          mkdir -p "${archive_dir}/doc"
          cp -v target/${{ matrix.target }}/release/gungraun-runner "$archive_dir"
          cp -v README.md LICENSE-MIT LICENSE-APACHE "$archive_dir"
          cp -v CHANGELOG.md "$archive_dir/doc"
          ls -laR "$archive_dir"
          tar czf "$archive_name" "$archive_dir"
          sha256sum "$archive_name" > "$archive_sum"
      - name: Upload archive
        if: env.CHECK == 'success'
        run: gh release upload "${{ needs.release.outputs.version }}" "${{ env.ARCHIVE_NAME }}" "${{ env.ARCHIVE_SUM }}"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
